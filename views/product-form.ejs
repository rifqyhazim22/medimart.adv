<%- include('partials/header') %>

    <div style="max-width: 800px; margin: 40px auto; padding: 0 20px;">
        <div
            style="background: white; padding: 30px; border-radius: 16px; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);">
            <h1 style="margin-top: 0;">
                <%= isEdit ? 'Edit Produk' : 'Tambah Produk Baru' %>
            </h1>

            <!-- Form -->
            <form id="productForm" action="<%= isEdit ? '/products/' + product.id + '?_method=PUT' : '/products' %>"
                method="POST" enctype="multipart/form-data">

                <!-- Hidden inputs for method override if needed (handled by query param usually but good to have) -->

                <div class="form-group" style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600;">Nama Produk</label>
                    <input type="text" name="name" value="<%= isEdit ? product.name : '' %>" required class="form-input"
                        style="width: 100%; padding: 12px; border: 1px solid #d1d5db; border-radius: 8px;">
                </div>

                <div class="form-group" style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600;">Kategori</label>
                    <select name="category" required
                        style="width: 100%; padding: 12px; border: 1px solid #d1d5db; border-radius: 8px; background: white;">
                        <option value="">Pilih Kategori</option>
                        <% const categories=['Obat Bebas', 'Obat Keras' , 'Vitamin' , 'Alat Kesehatan' , 'Herbal' ]; %>
                            <% categories.forEach(cat=> { %>
                                <option value="<%= cat %>" <%=isEdit && product.category===cat ? 'selected' : '' %>><%=
                                        cat %>
                                </option>
                                <% }); %>
                    </select>
                </div>

                <div class="form-group" style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600;">Deskripsi</label>
                    <textarea name="description" required rows="4"
                        style="width: 100%; padding: 12px; border: 1px solid #d1d5db; border-radius: 8px;"><%= isEdit ? product.description : '' %></textarea>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                    <div class="form-group">
                        <label style="display: block; margin-bottom: 8px; font-weight: 600;">Harga (Rp)</label>
                        <input type="number" name="price" value="<%= isEdit ? product.price : '' %>" required min="0"
                            style="width: 100%; padding: 12px; border: 1px solid #d1d5db; border-radius: 8px;">
                    </div>
                    <div class="form-group">
                        <label style="display: block; margin-bottom: 8px; font-weight: 600;">Stok</label>
                        <input type="number" name="stock" value="<%= isEdit ? product.stock : '' %>" required min="0"
                            style="width: 100%; padding: 12px; border: 1px solid #d1d5db; border-radius: 8px;">
                    </div>
                </div>

                <!-- Image Upload Section -->
                <div class="form-group" style="margin-bottom: 30px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600;">Foto Produk</label>

                    <!-- Current Image Preview -->
                    <% if (isEdit && product.image_url) { %>
                        <div style="margin-bottom: 15px; display: flex; align-items: start; gap: 20px;">
                            <div>
                                <p style="font-size: 12px; color: #666; margin-bottom: 4px;">Tampilan di Toko:</p>
                                <img src="<%= product.image_url %>"
                                    style="height: 120px; width: 120px; object-fit: contain; border-radius: 8px; border: 1px solid #ddd; background: #f9f9f9;">
                            </div>

                            <% if (product.original_image_url) { %>
                                <div style="display: flex; flex-direction: column; gap: 10px;">
                                    <div>
                                        <p style="font-size: 12px; color: #666; margin-bottom: 4px;">Sumber Asli:</p>
                                        <img src="<%= product.original_image_url %>" id="originalSource"
                                            style="height: 80px; width: 80px; object-fit: contain; border-radius: 8px; border: 1px solid #ddd; opacity: 0.7;">
                                    </div>
                                    <button type="button" id="btnReCrop" class="btn-secondary"
                                        style="font-size: 12px; padding: 6px 12px;">‚úÇÔ∏è Crop Ulang dari Asli</button>
                                </div>
                                <% } %>
                        </div>
                        <% } %>

                            <!-- File Input -->
                            <div id="uploadInputSection">
                                <input type="file" id="imageInput" name="image" accept="image/*"
                                    style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 8px; background: #f9f9f9;">
                                <p style="font-size: 12px; color: #6b7280; margin-top: 4px;">
                                    <%= isEdit ? 'Upload gambar baru untuk mengganti.' : 'Upload gambar produk.' %>
                                        Format: JPG, PNG. Maks 5MB.
                                </p>
                            </div>

                            <!-- Editor Container (Hidden initially) -->
                            <div id="cropContainer"
                                style="display:none; margin-top: 20px; background: #fceaee; padding: 15px; border-radius: 12px;">
                                <h4 style="margin: 0 0 10px 0; font-size: 14px;">Editor Foto</h4>
                                <div style="max-height: 400px; overflow: hidden; background: #333; border-radius: 8px;">
                                    <img id="imageToCrop" style="max-width: 100%; display: block;">
                                </div>
                                <div
                                    style="margin-top: 15px; text-align: right; display: flex; justify-content: flex-end; gap: 10px;">
                                    <button type="button" id="btnCropCancel" class="btn-secondary">Batal</button>
                                    <button type="button" id="btnCropApply" class="btn-primary">Terapkan Crop</button>
                                </div>
                            </div>

                            <!-- New Crop Preview -->
                            <div id="newImagePreview" style="display:none; margin-top: 20px;">
                                <p style="font-size: 12px; color: #00B09B; font-weight: bold;">Hasil Crop Baru:</p>
                                <div style="display: flex; align-items: center; gap: 15px;">
                                    <img id="previewResult"
                                        style="height: 120px; width: 120px; object-fit: contain; border-radius: 8px; border: 2px solid #00B09B; background: white;">
                                    <button type="button" id="btnResetUpload"
                                        style="background: none; border: none; color: #d9534f; cursor: pointer; text-decoration: underline; font-size: 13px;">
                                        Batalkan Ubahan
                                    </button>
                                </div>
                            </div>
                </div>

                <div style="display: flex; gap: 16px;">
                    <a href="/seller/dashboard" class="btn-cancel"
                        style="text-align: center; text-decoration: none; padding: 12px 24px;">Kembali</a>
                    <button type="submit" id="btnSubmit" class="btn-primary" style="flex: 1;">Simpan Produk</button>
                </div>
            </form>
        </div>
    </div>

    <!-- CropperJS CSS & JS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Elements
            const imageInput = document.getElementById('imageInput');
            const cropContainer = document.getElementById('cropContainer');
            const imageToCrop = document.getElementById('imageToCrop');
            const btnCropCancel = document.getElementById('btnCropCancel');
            const btnCropApply = document.getElementById('btnCropApply');
            const newImagePreview = document.getElementById('newImagePreview');
            const previewResult = document.getElementById('previewResult');
            const btnResetUpload = document.getElementById('btnResetUpload');
            const btnReCrop = document.getElementById('btnReCrop');
            const productForm = document.getElementById('productForm');
            const btnSubmit = document.getElementById('btnSubmit');
            const uploadInputSection = document.getElementById('uploadInputSection');

            // State
            let cropper = null;
            let croppedBlob = null;
            let mode = 'upload'; // 'upload' or 'recrop'

            // --- 1. Handle New File Upload ---
            imageInput.addEventListener('change', function (e) {
                const file = e.target.files[0];
                if (file) {
                    mode = 'upload';
                    startCropping(file);
                }
            });

            // --- 2. Handle Re-Crop Existing ---
            if (btnReCrop) {
                btnReCrop.addEventListener('click', function () {
                    mode = 'recrop';
                    const originalSrc = document.getElementById('originalSource').src;
                    // Need to fetch blob from URL to load into cropper cleanly to avoid CORS issues if cross-origin (but here it is local)
                    // Or just set src.

                    // Simple src set logic:
                    imageToCrop.src = originalSrc;

                    // Hide other inputs
                    uploadInputSection.style.display = 'none';
                    if (btnReCrop) btnReCrop.style.display = 'none';

                    showCropper();
                });
            }

            function startCropping(file) {
                const reader = new FileReader();
                reader.onload = function (evt) {
                    imageToCrop.src = evt.target.result;
                    uploadInputSection.style.display = 'none';
                    if (btnReCrop) btnReCrop.style.display = 'none';
                    showCropper();
                };
                reader.readAsDataURL(file);
            }

            function showCropper() {
                cropContainer.style.display = 'block';
                newImagePreview.style.display = 'none';

                if (cropper) cropper.destroy();
                cropper = new Cropper(imageToCrop, {
                    aspectRatio: 1, // 1:1 Square
                    viewMode: 1,
                    autoCropArea: 0.9,
                });
            }

            // --- 3. Crop Actions ---
            btnCropCancel.addEventListener('click', function () {
                resetFormState();
            });

            btnCropApply.addEventListener('click', function () {
                if (!cropper) return;

                const canvas = cropper.getCroppedCanvas({ width: 600, height: 600 });
                canvas.toBlob(function (blob) {
                    croppedBlob = blob;
                    previewResult.src = canvas.toDataURL();

                    // UI Update
                    cropContainer.style.display = 'none';
                    newImagePreview.style.display = 'block';

                    // Destroy cropper
                    cropper.destroy();
                    cropper = null;

                }, 'image/jpeg', 0.9);
            });

            btnResetUpload.addEventListener('click', function () {
                resetFormState();
            });

            function resetFormState() {
                // Determine what to reset based on mode? 
                // Simplest is to just reset everything to initial state
                cropContainer.style.display = 'none';
                newImagePreview.style.display = 'none';
                uploadInputSection.style.display = 'block';
                imageInput.value = ''; // clear input
                if (btnReCrop) btnReCrop.style.display = 'inline-block';

                croppedBlob = null;
                if (cropper) {
                    cropper.destroy();
                    cropper = null;
                }
            }

            // --- 4. Form Submission ---
            productForm.addEventListener('submit', function (e) {
                e.preventDefault();

                const originalBtnText = btnSubmit.innerText;
                btnSubmit.innerText = 'Menyimpan...';
                btnSubmit.disabled = true;

                // üß† Modal Penenang IT
                Swal.fire({
                    title: 'Menyimpan Produk..',
                    html: '<span style="color:#4b5563; font-size:15px;">Mengamankan data dan meregistrasi katalog ke rak toko Anda üì¶</span>',
                    allowOutsideClick: false,
                    showConfirmButton: false,
                    willOpen: () => Swal.showLoading(),
                    showClass: { popup: 'animate__animated animate__fadeInUp animate__faster' },
                    customClass: { popup: 'psych-modal' }
                });

                setTimeout(() => {
                    if (croppedBlob) {
                        const formData = new FormData(productForm);
                        if (mode === 'upload') {
                            formData.append('croppedImage', croppedBlob, 'cropped.jpg');
                        } else if (mode === 'recrop') {
                            formData.append('croppedImage', croppedBlob, 'recrop.jpg');
                        }

                        fetch(productForm.action, {
                            method: 'POST',
                            body: formData
                        })
                            .then(response => {
                                if (response.redirected) window.location.href = response.url;
                                else if (response.ok) window.location.href = '/seller/dashboard';
                                else throw new Error('Upload failed');
                            })
                            .catch(err => {
                                console.error(err);
                                window.showToast('Gagal menyimpan produk.', 'error');
                                btnSubmit.innerText = originalBtnText;
                                btnSubmit.disabled = false;
                            });
                    } else {
                        // Standard submit
                        productForm.submit();
                    }
                }, 1200);
            });
        });
    </script>

    <%- include('partials/footer') %>