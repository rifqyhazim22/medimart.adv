<%- include('../partials/header', { activeTab: 'marketplace' }) %>

    <div class="container" style="padding: 40px 20px; max-width: 1200px; margin: 0 auto; min-height: 80vh;">
        <!-- Store Banner & Profile Header -->
        <div
            style="background: var(--bg-white); border-radius: 24px; box-shadow: 0 10px 25px -5px rgba(0,0,0,0.05); overflow: hidden; margin-bottom: 40px; position: relative;">
            <!-- Banner Image (Fallback gradient) -->
            <div style="height: 200px; background: linear-gradient(135deg, #FF6B35 0%, #E040FB 100%);">
                <% if (seller && seller.Seller && seller.Seller.store_banner) { %>
                    <img src="<%= seller.Seller.store_banner %>"
                        style="width: 100%; height: 100%; object-fit: cover; opacity: 0.9;">
                    <% } %>
            </div>

            <div style="padding: 0 40px 40px 40px; display: flex; align-items: flex-end; gap: 24px; margin-top: -60px;">
                <!-- Avatar Profile -->
                <div
                    style="width: 140px; height: 140px; border-radius: 50%; border: 6px solid white; background: var(--bg-white); flex-shrink: 0; box-shadow: 0 4px 10px rgba(0,0,0,0.1); overflow: hidden; display: flex; justify-content: center; align-items: center; font-size: 50px; background: var(--border);">
                    <% if (seller.profile_image) { %>
                        <img src="<%= seller.profile_image %>" style="width: 100%; height: 100%; object-fit: cover;">
                        <% } else { %>
                            üè™
                            <% } %>
                </div>

                <!-- Store Info Details -->
                <div style="flex: 1; padding-bottom: 8px;">
                    <div
                        style="display: flex; justify-content: space-between; align-items: flex-start; gap: 16px; flex-wrap: wrap;">
                        <h1 style="font-size: 32px; font-weight: 800; color: var(--text-dark); margin: 0 0 8px 0;">
                            <%= seller.Seller && seller.Seller.store_name ? seller.Seller.store_name : (seller.full_name
                                || seller.username) %>
                        </h1>
                        <% if (typeof currentUser !=='undefined' && currentUser && currentUser.id===seller.id) { %>
                            <button onclick="window.location.href='/seller/settings'" class="btn"
                                style="background: var(--bg-white); color: #3b82f6; border: 1px solid #3b82f6; text-decoration: none; padding: 10px 16px; border-radius: 8px; font-weight: 600; display: inline-flex; align-items: center; gap: 8px; transition: all 0.2s; box-shadow: 0 2px 4px rgba(59, 130, 246, 0.1);"
                                onmouseover="this.style.background='#eff6ff'" onmouseout="this.style.background='white'"
                                onmousedown="this.style.transform='scale(0.95)'"
                                onmouseup="this.style.transform='scale(1)'">
                                <span data-i18n="store.settings">‚öôÔ∏è Pengaturan Toko</span>
                            </button>
                            <% } %>
                    </div>

                    <div style="display: flex; gap: 16px; align-items: center; flex-wrap: wrap;">
                        <div
                            style="display: inline-flex; align-items: center; gap: 6px; padding: 6px 14px; background: var(--border); color: var(--text-gray); border-radius: 99px; font-size: 13px; font-weight: 600;">
                            <span>üì¶</span>
                            <span>
                                <%= products.length %> <span data-i18n="store.products_count">Produk Etalase</span>
                            </span>
                        </div>
                        <% if (seller.phone) { %>
                            <div
                                style="display: inline-flex; align-items: center; gap: 6px; padding: 6px 14px; background: #f0fdf4; color: #166534; border-radius: 99px; font-size: 13px; font-weight: 600;">
                                <span>üìû</span> <span data-i18n="store.verified">Mitra Terverifikasi</span>
                            </div>
                            <% } %>
                                <div
                                    style="display: inline-flex; align-items: center; gap: 6px; padding: 6px 14px; background: #eff6ff; color: #1e40af; border-radius: 99px; font-size: 13px; font-weight: 600;">
                                    <span>‚úâÔ∏è</span>
                                    <%= seller.email %>
                                </div>
                                <div
                                    style="display: inline-flex; align-items: center; gap: 6px; padding: 6px 14px; background: #fef2f2; color: #b91c1c; border-radius: 99px; font-size: 13px; font-weight: 600;">
                                    <span>‚è±Ô∏è</span> <span data-i18n="store.joined_since">Bergabung Sejak</span>
                                    <%= new Date(seller.createdAt).getFullYear() %>
                                </div>
                    </div>

                    <% if (seller.Seller && seller.Seller.store_description) { %>
                        <p
                            style="margin: 16px 0 0 0; color: var(--text-gray); font-size: 15px; max-width: 800px; line-height: 1.6;">
                            <%= seller.Seller.store_description %>
                        </p>
                        <% } else { %>
                            <p style="margin: 16px 0 0 0; color: var(--text-gray); font-size: 14px; font-style: italic;"
                                data-i18n="store.no_desc">
                                Belum ada deskripsi toko yang ditambahkan.
                            </p>
                            <% } %>

                                <% if (seller.Seller && seller.Seller.store_address) { %>
                                    <div
                                        style="margin-top: 16px; color: var(--text-gray); font-size: 14px; display: flex; align-items: center; gap: 8px; background: var(--bg-light); padding: 12px 16px; border-radius: 12px; display: inline-flex; border: 1px dashed var(--border);">
                                        <span style="font-size: 18px;">üìç</span>
                                        <span>
                                            <%= seller.Seller.store_address %>
                                        </span>
                                    </div>
                                    <% } %>
                </div>
            </div>
        </div>

        <!-- Store Products Catalog -->
        <div class="section-header" style="margin-bottom: 24px;">
            <h2 class="section-title" data-i18n="store.catalog">Katalog Produk</h2>
        </div>

        <div class="products-grid" id="storeProducts">
            <% if (products.length===0) { %>
                <div
                    style="grid-column: 1/-1; text-align: center; padding: 60px 20px; background: var(--bg-white); border-radius: 20px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05);">
                    <span style="font-size: 48px; display: block; margin-bottom: 16px;">üîç</span>
                    <h3 style="font-size: 20px; color: var(--text-dark); margin-bottom: 8px;"
                        data-i18n="store.empty_title">Etalase Masih Kosong</h3>
                    <p style="color: var(--text-gray);" data-i18n="store.empty_desc">Penjual belum mengunggah produk
                        apapun di tokonya saat ini.</p>
                </div>
                <% } else { %>
                    <% products.forEach(product=> { %>
                        <div class="product-card" style="cursor: pointer; position: relative;"
                            onclick="if(event.target.tagName !== 'BUTTON' && event.target.tagName !== 'A') window.location.href='/product/<%= product.id %>'">
                            <div class="product-image">
                                <img src="<%= product.image_url || '/img/default-product.svg' %>"
                                    alt="<%= product.name %>" style="width: 100%; height: 100%; object-fit: cover;">
                            </div>
                            <div class="product-info">
                                <div
                                    style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                    <div class="product-category" style="margin-bottom: 0;">
                                        <% const icons={ 'Obat Bebas' : 'üíä' , 'Obat Keras' : 'üíâ' , 'Vitamin' : 'üçä'
                                            , 'Alat Kesehatan' : 'ü©π' , 'Herbal' : 'üåø' }; const
                                            icon=icons[product.category] || 'üíä' ; %>
                                            <%= icon %>
                                                <%= product.category %>
                                    </div>
                                    <% if (product.stock===0) { %>
                                        <span class="stock-badge error"
                                            style="background: #fee2e2; color: #dc2626; padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: 600;"
                                            data-i18n="cart.out_of_stock">Habis</span>
                                        <% } else if (product.stock <=5) { %>
                                            <span class="stock-badge warning"
                                                style="background: #fef3c7; color: #d97706; padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: 600;">Sisa:
                                                <%= product.stock %>
                                            </span>
                                            <% } else { %>
                                                <span class="stock-badge"
                                                    style="background: #d1fae5; color: #059669; padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: 600;">Stok:
                                                    <%= product.stock %>
                                                </span>
                                                <% } %>
                                </div>
                                <h3 class="product-title">
                                    <%= product.name %>
                                </h3>

                                <div class="product-footer">
                                    <div class="product-price">Rp <%= parseInt(product.price).toLocaleString('id-ID') %>
                                    </div>
                                    <% if (typeof currentUser !=='undefined' && currentUser &&
                                        currentUser.id===seller.id) { %>
                                        <button disabled class="btn-add-cart"
                                            style="background: var(--border); color: var(--text-gray); cursor: not-allowed; border: 1px dashed var(--border);"
                                            data-i18n="store.own_product">
                                            Barang Anda
                                        </button>
                                        <% } else { %>
                                            <form action="/cart/add" method="POST" class="store-cart-form">
                                                <input type="hidden" name="productId" value="<%= product.id %>">
                                                <button type="submit" class="btn-add-cart" <%=product.stock===0
                                                    ? 'disabled' : '' %>>
                                                    <span
                                                        data-i18n="<%= product.stock===0 ? 'cart.out_of_stock' : 'cart.add_cart' %>">
                                                        <%= product.stock===0 ? 'Habis' : '+ Keranjang' %>
                                                    </span>
                                                </button>
                                            </form>
                                            <% } %>
                                </div>
                            </div>
                        </div>
                        <% }); %>
                            <% } %>
        </div>
    </div>

    <script>
        // AJAX Add to Cart for Store Page
        document.querySelectorAll('.store-cart-form').forEach(form => {
            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                const btn = form.querySelector('button');
                const originalText = btn.innerHTML;
                btn.innerHTML = '‚è≥...';
                btn.disabled = true;

                try {
                    const formData = new URLSearchParams(new FormData(form));
                    const response = await fetch('/cart/add', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                            'Accept': 'application/json',
                            'X-Requested-With': 'XMLHttpRequest'
                        },
                        body: formData
                    });
                    const data = await response.json();

                    if (data.success) {
                        window.showToast(data.message || t('toast.add_success'), 'success');

                        const badge = document.getElementById('cartBadge');
                        if (badge) {
                            badge.innerText = data.cartCount;
                            if (data.cartCount > 0) badge.style.display = 'flex';
                        }
                    } else {
                        window.showToast(data.message || t('toast.add_failed'), 'error');
                    }
                } catch (err) {
                    console.error(err);
                    window.showToast(t('toast.connection_error'), 'error');
                } finally {
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                }
            });
        });
    </script>

    <%- include('../partials/footer') %>