<%- include('../partials/header', { activeTab: 'dashboard' }) %>


    <style>
        /* Embedded Premium Dashboard Styles */
        .dashboard-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 40px 20px;
        }

        /* Header & Stats */
        .dashboard-header {
            background: transparent;
            padding: 0;
            box-shadow: none;
            color: var(--text-dark);
            margin-bottom: 40px;
        }

        .dashboard-header h1 {
            font-size: 32px;
            font-weight: 800;
            color: var(--text-dark);
            margin-bottom: 8px;
            background: none;
            -webkit-text-fill-color: initial;
        }

        .dashboard-header p {
            color: var(--text-gray);
            font-size: 16px;
        }

        .dashboard-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 24px;
            margin-top: 32px;
            margin-bottom: 40px;
        }

        .stat-card {
            background: var(--bg-white);
            padding: 24px;
            border-radius: 16px;
            border: 1px solid var(--border);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
            display: flex;
            align-items: center;
            gap: 20px;
            transition: transform 0.2s;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        .stat-icon {
            width: 56px;
            height: 56px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            flex-shrink: 0;
        }

        .stat-icon.blue {
            background: #eff6ff;
            color: #3b82f6;
        }

        .stat-icon.orange {
            background: #fff7ed;
            color: #f97316;
        }

        .stat-icon.green {
            background: #f0fdf4;
            color: #22c55e;
        }

        .stat-icon.purple {
            background: #f3e8ff;
            color: #a855f7;
        }

        .stat-content h3 {
            margin: 0;
            color: var(--text-gray);
            font-size: 13px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 4px;
        }

        .stat-value {
            font-size: 26px;
            font-weight: 700;
            color: var(--text-dark);
            margin: 0;
        }

        .stat-subtitle {
            font-size: 12px;
            color: var(--text-gray);
            margin-top: 4px;
        }

        .dashboard-section {
            background: var(--bg-white);
            border-radius: 16px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
            border: 1px solid var(--border);
            padding: 24px;
            margin-bottom: 40px;
        }

        .dashboard-section h2 {
            font-size: 20px;
            font-weight: 700;
            color: var(--text-dark);
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--border);
        }

        .data-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
        }

        .data-table th {
            text-align: left;
            padding: 12px 16px;
            color: var(--text-gray);
            font-size: 13px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            border-bottom: 1px solid var(--border);
        }

        .data-table td {
            padding: 16px;
            color: var(--text-dark);
            font-size: 14px;
            border-bottom: 1px solid var(--border);
        }

        .data-table tr:last-child td {
            border-bottom: none;
        }

        .badge {
            padding: 6px 12px;
            border-radius: 9999px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .badge-primary {
            background: #dbeafe;
            color: #1e40af;
        }

        .badge-success {
            background: #d1fae5;
            color: #065f46;
        }

        .badge-warning {
            background: #fef3c7;
            color: #92400e;
        }

        .badge-danger {
            background: #fee2e2;
            color: #b91c1c;
        }

        .badge-info {
            background: #dbeafe;
            color: #1e40af;
        }

        .badge-pending {
            background: var(--border);
            color: var(--text-gray);
        }

        .btn-icon-danger {
            background: transparent;
            color: #ef4444;
            border: 1px solid #fee2e2;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            transition: all 0.2s;
        }

        .btn-icon-danger:hover {
            background: #fee2e2;
            color: #b91c1c;
        }
    </style>

    <div class="main-container">
        <div class="dashboard-container">
            <header class="dashboard-header">
                <h1 data-i18n="admin.title">Admin Dashboard</h1>
                <p data-i18n="admin.subtitle">Overview Sistem & Manajemen User</p>
            </header>

            <!-- System Stats -->
            <div class="dashboard-stats">
                <div class="stat-card">
                    <div class="stat-icon blue">ðŸ‘¥</div>
                    <div class="stat-content">
                        <h3 data-i18n="admin.total_user">Total User</h3>
                        <div class="stat-value">
                            <%= stats.totalUsers %>
                        </div>
                        <div class="stat-subtitle">
                            <%= stats.totalSellers %> Sellers, <%= stats.totalCustomers %> Customers,
                                    <%= stats.totalAdmins %> Admins
                        </div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon orange">ðŸ“¦</div>
                    <div class="stat-content">
                        <h3 data-i18n="admin.total_product">Total Produk</h3>
                        <div class="stat-value">
                            <%= stats.totalProducts %>
                        </div>
                        <div class="stat-subtitle" data-i18n="admin.active_platform">Aktif di platform</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon purple">ðŸ›’</div>
                    <div class="stat-content">
                        <h3 data-i18n="admin.total_order">Total Pesanan</h3>
                        <div class="stat-value">
                            <%= stats.totalOrders %>
                        </div>
                        <div class="stat-subtitle" data-i18n="admin.all_status">Semua status</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon green">ðŸ’°</div>
                    <div class="stat-content">
                        <h3 data-i18n="admin.net_profit">Laba Bersih Admin</h3>
                        <div class="stat-value">Rp <%= (stats.adminRevenue || 0).toLocaleString('id-ID') %>
                        </div>
                        <div class="stat-subtitle"><span data-i18n="admin.margin_prefix">Margin 10% dari GMV:</span> Rp
                            <%= (stats.totalRevenue || 0).toLocaleString('id-ID') %>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Chart Infographic Section -->
            <section class="dashboard-section"
                style="margin-bottom: 40px; display: flex; flex-wrap: wrap; gap: 40px; align-items: stretch; justify-content: center; background: var(--bg-white); border: 1px solid var(--border); box-shadow: var(--shadow-md);">
                <div
                    style="flex: 1; min-width: 300px; max-width: 350px; display: flex; flex-direction: column; justify-content: center; align-items: center;">
                    <h2 style="border-bottom: none; margin-bottom: 24px; font-size: 18px; text-align: center; color: var(--text-dark);"
                        data-i18n="admin.platform_composition">
                        Komposisi Platform</h2>
                    <canvas id="usersChart" width="300" height="300"></canvas>
                </div>
                <div style="flex: 2; min-width: 300px; display: flex;">
                    <div
                        style="background: var(--bg-light); color: var(--text-dark); padding: 32px; border-radius: 20px; box-shadow: inset 0 2px 4px rgba(0,0,0,0.02); border: 1px solid var(--border); position: relative; overflow: hidden; display: flex; flex-direction: column; justify-content: center; width: 100%;">

                        <!-- Decoration elements -->
                        <div
                            style="position: absolute; top: -50px; right: -50px; width: 150px; height: 150px; background: rgba(0, 176, 155, 0.05); border-radius: 50%;">
                        </div>
                        <div
                            style="position: absolute; bottom: -30px; right: 20px; width: 100px; height: 100px; background: rgba(255, 107, 53, 0.05); border-radius: 50%;">
                        </div>

                        <div
                            style="display: flex; align-items: center; gap: 12px; margin-bottom: 24px; position: relative; z-index: 1;">
                            <div
                                style="background: var(--bg-white); padding: 8px; border-radius: 12px; font-size: 20px; box-shadow: var(--shadow-sm); border: 1px solid var(--border);">
                                ðŸŒŸ</div>
                            <h3 style="margin: 0; font-size: 20px; font-weight: 700; letter-spacing: 0.02em; color: var(--text-dark);"
                                data-i18n="admin.system_perf">
                                Intelijen Performa Sistem</h3>
                        </div>

                        <div
                            style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; position: relative; z-index: 1;">
                            <div
                                style="background: var(--bg-white); padding: 20px; border-radius: 16px; border: 1px solid var(--border); box-shadow: var(--shadow-sm);">
                                <h4 style="margin: 0 0 8px 0; font-size: 13px; color: var(--text-gray); text-transform: uppercase; letter-spacing: 0.05em;"
                                    data-i18n="admin.store_hub">
                                    Pusat Etalase Obat</h4>
                                <p style="margin: 0; font-size: 15px; color: var(--text-dark); line-height: 1.6;">
                                    Menghimpun <strong style="color: #3b82f6; font-size: 18px;">
                                        <%= stats.totalProducts %>
                                    </strong> obat-obatan yang dinaungi oleh <strong
                                        style="color: #3b82f6; font-size: 18px;">
                                        <%= stats.totalSellers %>
                                    </strong> Mitra Lapak Aktif.</p>
                            </div>

                            <div
                                style="background: var(--bg-white); padding: 20px; border-radius: 16px; border: 1px solid var(--border); box-shadow: var(--shadow-sm);">
                                <h4 style="margin: 0 0 8px 0; font-size: 13px; color: var(--text-gray); text-transform: uppercase; letter-spacing: 0.05em;"
                                    data-i18n="admin.capital_flow">
                                    Sirkulasi Kapital (GMV)</h4>
                                <p style="margin: 0; font-size: 15px; color: var(--text-dark); line-height: 1.6;">
                                    Perputaran dana kotor sebesar <strong style="color: #10b981; font-size: 18px;">Rp
                                        <%= (stats.totalRevenue || 0).toLocaleString('id-ID') %>
                                    </strong> via kesuksesan
                                    <strong style="color: #f43f5e; font-size: 18px;">
                                        <%= stats.totalOrders %>
                                    </strong> transaksi pesanan.
                                </p>
                            </div>

                            <div
                                style="grid-column: 1 / -1; background: linear-gradient(135deg, var(--primary), var(--primary-dark)); padding: 20px; border-radius: 16px; box-shadow: var(--shadow-md); display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 16px;">
                                <div>
                                    <h4 style="margin: 0 0 4px 0; font-size: 13px; color: rgba(255,255,255,0.9); text-transform: uppercase; letter-spacing: 0.05em; font-weight: 700;"
                                        data-i18n="admin.dividend">
                                        Keuntungan Dividen (10% GMV)</h4>
                                    <p style="margin: 0; font-size: 13px; color: rgba(255,255,255,0.8);"
                                        data-i18n="admin.dividend_desc">Total
                                        penerimaan bersih potong margin untuk Medimart.</p>
                                </div>
                                <div
                                    style="font-size: 28px; font-weight: 800; color: white; text-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                    Rp <%= (stats.adminRevenue || 0).toLocaleString('id-ID') %>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- User List -->
            <section class="dashboard-section">
                <h2 data-i18n="admin.user_list">Daftar Pengguna</h2>
                <div class="table-responsive">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Username</th>
                                <th>Email</th>
                                <th>Role</th>
                                <th data-i18n="admin.col_registered">Terdaftar Pada</th>
                                <th data-i18n="admin.col_action">Aksi</th>
                            </tr>
                        </thead>
                        <tbody>
                            <% allUsers.forEach(user=> { %>
                                <tr>
                                    <td style="font-family: monospace; color: var(--text-gray);">#<%= user.id %>
                                    </td>
                                    <td style="font-weight: 500;">
                                        <%= user.username %>
                                    </td>
                                    <td>
                                        <%= user.email %>
                                    </td>
                                    <td>
                                        <span
                                            class="badge badge-<%= user.role === 'admin' ? 'primary' : (user.role === 'seller' ? 'warning' : 'success') %>">
                                            <%= user.role.charAt(0).toUpperCase() + user.role.slice(1) %>
                                        </span>
                                    </td>
                                    <td>
                                        <%= user.createdAt ? new Date(user.createdAt).toLocaleDateString('id-ID', {
                                            day: 'numeric' , month: 'short' , year: 'numeric' }) : '-' %>
                                    </td>
                                    <td>
                                        <% if (user.role !=='admin' ) { %>
                                            <form action="/admin/users/<%= user.id %>/delete" method="POST">
                                                <button type="submit" class="btn-icon-danger"
                                                    data-i18n="admin.btn_delete">Hapus</button>
                                            </form>
                                            <% } else { %>
                                                <span style="color: var(--border);">-</span>
                                                <% } %>
                                    </td>
                                </tr>
                                <% }) %>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- TRANSACTION HISTORY SECTION -->
            <section class="dashboard-section" style="margin-top: 40px;">
                <div class="section-header">
                    <h2 data-i18n="admin.transaction_history">Riwayat Transaksi (Terbaru)</h2>
                </div>
                <div class="table-responsive">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Order ID</th>
                                <th data-i18n="admin.col_customer">Pelanggan</th>
                                <th>Total</th>
                                <th>Status</th>
                                <th data-i18n="admin.col_date">Tanggal</th>
                                <th data-i18n="admin.col_action">Aksi</th>
                            </tr>
                        </thead>
                        <tbody>
                            <% if (recentOrders && recentOrders.length> 0) { %>
                                <% recentOrders.forEach(order=> { %>
                                    <tr>
                                        <td style="font-family: monospace; font-weight: 600;">#<%= order.id %>
                                        </td>
                                        <td>
                                            <%= order.customer_name %>
                                        </td>
                                        <td style="font-weight: 600;">Rp <%=
                                                parseFloat(order.total_price).toLocaleString('id-ID') %>
                                        </td>
                                        <td>
                                            <% // Minimalist Status Checking for Admin let statusClass='pending' ; let
                                                badgeText='Menunggu Proses' ; if (order.status==='paid' ) {
                                                statusClass='info' ; badgeText='Menunggu Proses' ; } else if
                                                (order.status==='processing' ) { statusClass='warning' ;
                                                badgeText='Sedang Diproses' ; } else if (order.status==='shipped' ) {
                                                statusClass='warning' ; badgeText='Sedang Dikirim' ; } else if
                                                (order.status==='completed' ) { statusClass='success' ;
                                                badgeText='Selesai' ; } else if (order.status==='cancelled' ) {
                                                statusClass='danger' ; badgeText='Dibatalkan Pembeli / Gagal Total' ; }
                                                else if (order.status==='rejected' ) { statusClass='danger' ;
                                                badgeText='Ditolak Penjual / Habis' ; } else { statusClass='pending' ;
                                                badgeText=order.status ? order.status.charAt(0).toUpperCase() +
                                                order.status.slice(1) : 'Unknown' ; } %>
                                                <span class="badge badge-<%= statusClass %>">
                                                    <%= badgeText %>
                                                </span>
                                        </td>
                                        <td>
                                            <%= order.created_at ? new
                                                Date(order.created_at).toLocaleDateString('id-ID', { day: 'numeric' ,
                                                month: 'short' , year: 'numeric' }) : '-' %>
                                        </td>
                                        <td>
                                            <form action="/admin/orders/<%= order.id %>/delete" method="POST"
                                                class="ajax-form delete-form">
                                                <button type="submit" class="btn-icon-danger"
                                                    data-i18n="admin.btn_delete">Hapus</button>
                                            </form>
                                        </td>
                                    </tr>
                                    <% }) %>
                                        <% } else { %>
                                            <tr>
                                                <td colspan="6"
                                                    style="text-align: center; padding: 40px; color: var(--text-gray);"
                                                    data-i18n="admin.no_transactions">
                                                    Belum ada transaksi terbaru.</td>
                                            </tr>
                                            <% } %>
                        </tbody>
                    </table>
                </div>
            </section>
        </div>
    </div>

    <%- include('../partials/footer') %>

        <!-- Include Chart.js -->
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

        <script>
            // Initialize User Roles Chart
            document.addEventListener('DOMContentLoaded', () => {
                const ctx = document.getElementById('usersChart');
                if (ctx) {
                    new Chart(ctx, {
                        type: 'doughnut',
                        data: {
                            labels: ['Customers', 'Sellers'],
                            datasets: [{
                                data: JSON.parse('<%- JSON.stringify(chartData || [0,0]) %>'),
                                backgroundColor: [
                                    '#3b82f6', // Blue for Customers
                                    '#f97316'  // Orange for Sellers
                                ],
                                borderWidth: 0,
                                hoverOffset: 4
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                legend: {
                                    position: 'bottom',
                                    labels: {
                                        padding: 20,
                                        font: { family: "'DM Sans', sans-serif", size: 13 }
                                    }
                                }
                            },
                            cutout: '70%'
                        }
                    });
                }
            });

            // AJAX Admin Delete
            document.addEventListener('DOMContentLoaded', () => {
                const handleAction = async (e) => {
                    const form = e.target.closest('form');
                    if (!form || !form.action.includes('/delete')) return;

                    e.preventDefault();

                    // Confirm reject
                    const msg = form.action.includes('users') ? t('admin.delete_user_confirm') : t('admin.delete_order_confirm');
                    const result = await Swal.fire({
                        title: t('swal.confirm'),
                        text: msg,
                        icon: 'warning',
                        showCancelButton: true,
                        confirmButtonColor: '#EF4444',
                        cancelButtonColor: '#9ca3af',
                        confirmButtonText: t('product.yes_delete'),
                        cancelButtonText: t('swal.cancel'),
                        reverseButtons: true
                    });
                    if (!result.isConfirmed) return;

                    const btn = form.querySelector('button');
                    const originalText = btn.innerHTML;
                    btn.innerHTML = 'â³';
                    btn.disabled = true;

                    try {
                        const response = await fetch(form.action, {
                            method: 'POST',
                            headers: {
                                'Accept': 'application/json',
                                'X-Requested-With': 'XMLHttpRequest'
                            }
                        });
                        const data = await response.json();

                        if (data.success) {
                            window.showToast(data.message, 'success');

                            // Remove Row with animation
                            const row = form.closest('tr');
                            row.style.transition = 'all 0.5s';
                            row.style.opacity = '0';
                            row.style.transform = 'translateX(20px)';
                            setTimeout(() => row.remove(), 500);

                        } else {
                            window.showToast(data.message || t('admin.failed'), 'error');
                            btn.innerHTML = originalText;
                            btn.disabled = false;
                        }
                    } catch (err) {
                        console.error(err);
                        window.showToast(t('toast.error_generic'), 'error');
                        btn.innerHTML = originalText;
                        btn.disabled = false;
                    }
                };

                // Delegate event to body/tables
                document.body.addEventListener('submit', handleAction);
            });
        </script>
        </body>

        </html>