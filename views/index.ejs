<%- include('partials/header', { activeTab: 'marketplace' }) %>

    <div id="marketplaceView">

        <!-- Recommendation Section -->
        <% if (typeof recommendedProducts !=='undefined' && recommendedProducts.length> 0 && (!searchQuery) &&
            (!category || category === 'all')) { %>
            <div
                style="margin: 20px 24px; padding: 24px; background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%); border-radius: 24px; color: white; box-shadow: 0 10px 25px -5px rgba(59, 130, 246, 0.4); position: relative; overflow: hidden;">
                <!-- Decorative Elements -->
                <div
                    style="position: absolute; top: -20px; right: -20px; width: 150px; height: 150px; background: rgba(255,255,255,0.1); border-radius: 50%; blur(10px);">
                </div>
                <div
                    style="position: absolute; bottom: -30px; left: 10%; width: 100px; height: 100px; background: rgba(255,255,255,0.05); border-radius: 50%;">
                </div>

                <div style="position: relative; z-index: 2;">
                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 20px;">
                        <span style="font-size: 24px;">‚ú®</span>
                        <h2 style="font-size: 22px; font-weight: 800; margin: 0; letter-spacing: 0.5px;"
                            data-i18n="<%= recoTitle === 'Berdasarkan Pembelian Anda' ? 'index.reco_personal' : 'index.reco_generic' %>">
                            <%= recoTitle %>
                        </h2>
                    </div>

                    <div
                        style="display: grid; grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); gap: 20px;">
                        <% recommendedProducts.forEach(product=> { %>
                            <div class="product-card" style="cursor: pointer; position: relative;"
                                onclick="if(event.target.tagName !== 'BUTTON' && event.target.tagName !== 'A') window.location.href='/product/<%= product.id %>'">
                                <div class="product-image">
                                    <img src="<%= product.image_url || '/img/default-product.svg' %>"
                                        alt="<%= product.name %>" style="width: 100%; height: 100%; object-fit: cover;">
                                </div>
                                <div class="product-info">
                                    <div
                                        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                        <div class="product-category" style="margin-bottom: 0;">
                                            <% const recoIcons={ 'Obat Bebas' : 'üíä' , 'Obat Keras' : 'üíâ' , 'Vitamin'
                                                : 'üçä' , 'Alat Kesehatan' : 'ü©π' , 'Herbal' : 'üåø' }; const
                                                recoIcon=recoIcons[product.category] || 'üíä' ; %>
                                                <%= recoIcon %>
                                                    <%= product.category %>
                                        </div>
                                        <% if (product.stock===0) { %>
                                            <span class="stock-badge error"
                                                style="background: #fee2e2; color: #dc2626; padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: 600;"><span
                                                    data-i18n="index.out_of_stock">Habis</span></span>
                                            <% } else if (product.stock <=5) { %>
                                                <span class="stock-badge warning"
                                                    style="background: #fef3c7; color: #d97706; padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: 600;"><span
                                                        data-i18n="index.remaining_prefix">Sisa:</span>
                                                    <%= product.stock %>
                                                </span>
                                                <% } else { %>
                                                    <span class="stock-badge"
                                                        style="background: #d1fae5; color: #059669; padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: 600;"><span
                                                            data-i18n="index.stock_prefix">Stok:</span>
                                                        <%= product.stock %>
                                                    </span>
                                                    <% } %>
                                    </div>
                                    <h3 class="product-title">
                                        <%= product.name %>
                                    </h3>

                                    <!-- Seller Info -->
                                    <div
                                        style="display: flex; align-items: center; gap: 6px; margin-bottom: 8px; font-size: 12px; color: var(--text-gray);">
                                        <span>üè™</span>
                                        <a href="/store/<%= product.seller_id %>"
                                            style="color: var(--text-gray); text-decoration: none; font-weight: 600; cursor: pointer; transition: color 0.2s;"
                                            onmouseover="this.style.color='#3b82f6'"
                                            onmouseout="this.style.color='#6b7280'">
                                            <%= product.seller ? (product.seller.full_name || product.seller.username)
                                                : 'Official Store' %>
                                        </a>
                                    </div>

                                    <div class="product-footer">
                                        <div class="product-price">Rp <%=
                                                parseInt(product.price).toLocaleString('id-ID') %>
                                        </div>
                                        <form action="/cart/add" method="POST">
                                            <input type="hidden" name="productId" value="<%= product.id %>">
                                            <button type="submit" class="btn-add-cart" <%=product.stock===0 ? 'disabled'
                                                : '' %>>
                                                <% if (product.stock===0) { %>
                                                    <span data-i18n="index.btn_out_of_stock">Habis</span>
                                                    <% } else { %>
                                                        <span data-i18n="index.btn_add_cart">+ Keranjang</span>
                                                        <% } %>
                                            </button>
                                        </form>
                                    </div>
                                </div>
                            </div>
                            <% }); %>
                    </div>
                </div>
            </div>
            <% } %>

                <div class="section-header">
                    <h2 class="section-title" data-i18n="index.explore">Eksplorasi Katalog</h2>
                </div>

                <!-- Category Filters -->
                <div class="category-filters">
                    <a href="/" class="filter-btn <%= (!category || category === 'all') ? 'active' : '' %>"
                        style="text-decoration: none;">
                        <span class="filter-icon">üè•</span> <span data-i18n="index.all">Semua</span>
                    </a>
                    <a href="/?category=Obat Bebas"
                        class="filter-btn <%= (category === 'Obat Bebas') ? 'active' : '' %>"
                        style="text-decoration: none;">
                        <span class="filter-icon">üíä</span> Obat Bebas
                    </a>
                    <a href="/?category=Obat Keras"
                        class="filter-btn <%= (category === 'Obat Keras') ? 'active' : '' %>"
                        style="text-decoration: none;">
                        <span class="filter-icon">üíâ</span> Obat Keras
                    </a>
                    <a href="/?category=Obat Nyeri"
                        class="filter-btn <%= (category === 'Obat Nyeri') ? 'active' : '' %>"
                        style="text-decoration: none;">
                        <span class="filter-icon">ü©∫</span> Obat Nyeri
                    </a>
                    <a href="/?category=Vitamin" class="filter-btn <%= (category === 'Vitamin') ? 'active' : '' %>"
                        style="text-decoration: none;">
                        <span class="filter-icon">üçä</span> Vitamin
                    </a>
                    <a href="/?category=Alat Kesehatan"
                        class="filter-btn <%= (category === 'Alat Kesehatan') ? 'active' : '' %>"
                        style="text-decoration: none;">
                        <span class="filter-icon">ü©π</span> Alkes
                    </a>
                    <a href="/?category=Herbal" class="filter-btn <%= (category === 'Herbal') ? 'active' : '' %>"
                        style="text-decoration: none;">
                        <span class="filter-icon">üåø</span> Herbal
                    </a>
                </div>

                <div class="products-grid" id="marketplaceProducts">
                    <% if (products.length===0) { %>
                        <div style="grid-column: 1/-1; text-align: center; padding: 40px; color: var(--text-gray);">
                            <p data-i18n="index.no_products">Belum ada produk yang tersedia.</p>
                        </div>
                        <% } else { %>
                            <% products.forEach(product=> { %>
                                <div class="product-card" style="cursor: pointer; position: relative;"
                                    onclick="if(event.target.tagName !== 'BUTTON' && event.target.tagName !== 'A') window.location.href='/product/<%= product.id %>'">
                                    <div class="product-image">
                                        <img src="<%= product.image_url || '/img/default-product.svg' %>"
                                            alt="<%= product.name %>"
                                            style="width: 100%; height: 100%; object-fit: cover;">
                                    </div>
                                    <div class="product-info">
                                        <div
                                            style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                            <div class="product-category" style="margin-bottom: 0;">
                                                <% const icons={ 'Obat Bebas' : 'üíä' , 'Obat Keras' : 'üíâ' , 'Vitamin'
                                                    : 'üçä' , 'Alat Kesehatan' : 'ü©π' , 'Herbal' : 'üåø' }; const
                                                    icon=icons[product.category] || 'üíä' ; %>
                                                    <%= icon %>
                                                        <%= product.category %>
                                            </div>
                                            <% if (product.stock===0) { %>
                                                <span class="stock-badge error"
                                                    style="background: #fee2e2; color: #dc2626; padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: 600;"><span
                                                        data-i18n="index.out_of_stock">Habis</span></span>
                                                <% } else if (product.stock <=5) { %>
                                                    <span class="stock-badge warning"
                                                        style="background: #fef3c7; color: #d97706; padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: 600;"><span
                                                            data-i18n="index.remaining_prefix">Sisa:</span>
                                                        <%= product.stock %>
                                                    </span>
                                                    <% } else { %>
                                                        <span class="stock-badge"
                                                            style="background: #d1fae5; color: #059669; padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: 600;"><span
                                                                data-i18n="index.stock_prefix">Stok:</span>
                                                            <%= product.stock %>
                                                        </span>
                                                        <% } %>
                                        </div>
                                        <h3 class="product-title">
                                            <%= product.name %>
                                        </h3>

                                        <!-- Seller Info -->
                                        <div
                                            style="display: flex; align-items: center; gap: 6px; margin-bottom: 8px; font-size: 12px; color: var(--text-gray);">
                                            <span>üè™</span>
                                            <a href="/store/<%= product.seller_id %>"
                                                style="color: var(--text-gray); text-decoration: none; font-weight: 600; cursor: pointer; transition: color 0.2s;"
                                                onmouseover="this.style.color='#3b82f6'"
                                                onmouseout="this.style.color='#6b7280'">
                                                <%= product.seller ? (product.seller.full_name ||
                                                    product.seller.username) : 'Official Store' %>
                                            </a>
                                        </div>

                                        <div class="product-footer">
                                            <div class="product-price">Rp <%=
                                                    parseInt(product.price).toLocaleString('id-ID') %>
                                            </div>
                                            <form action="/cart/add" method="POST">
                                                <input type="hidden" name="productId" value="<%= product.id %>">
                                                <button type="submit" class="btn-add-cart" <%=product.stock===0
                                                    ? 'disabled' : '' %>>
                                                    <% if (product.stock===0) { %>
                                                        <span data-i18n="index.btn_out_of_stock">Habis</span>
                                                        <% } else { %>
                                                            <span data-i18n="index.btn_add_cart">+ Keranjang</span>
                                                            <% } %>
                                                </button>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                                <% }); %>
                                    <% } %>
                </div>
    </div>

    <!-- Sticky Checkout Bar (Always rendered but toggled via display) -->
    <div id="stickyCheckoutBar" style="
        display: <%= (typeof cartCount !== 'undefined' && cartCount > 0) ? 'flex' : 'none' %>;
        position: fixed; 
        bottom: 24px; 
        right: 24px; 
        z-index: 999; 
        background: linear-gradient(135deg, #FF6B35, #FF5252, #E040FB);
        backdrop-filter: blur(8px);
        -webkit-backdrop-filter: blur(8px);
        padding: 8px 16px 8px 16px; 
        border-radius: 99px; 
        box-shadow: 0 10px 25px -5px rgba(224, 64, 251, 0.4);
        align-items: center; 
        gap: 16px;
        animation: floatUp 0.6s cubic-bezier(0.16, 1, 0.3, 1);
        color: white;
    ">
        <div style="display: flex; align-items: center; gap: 12px;">
            <div style="
                background: rgba(255,255,255,0.25);
                width: 38px;
                height: 38px;
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 18px;
                box-shadow: inset 0 2px 4px rgba(255,255,255,0.3);
            ">
                üõçÔ∏è
            </div>
            <div style="display: flex; flex-direction: column;">
                <span
                    style="font-size: 11px; color: rgba(255,255,255,0.95); font-weight: 500; letter-spacing: 0.5px; text-transform: uppercase;">
                    Total Belanja
                </span>
                <div style="display: flex; align-items:baseline; gap: 6px;">
                    <span style="font-size: 16px; font-weight: 800; color: #ffffff;" id="stickyTotal">Rp <%=
                            parseInt(typeof cartTotal !=='undefined' ? cartTotal : 0).toLocaleString('id-ID') %></span>
                    <span
                        style="font-size: 11px; color: #FF5252; font-weight: 700; background: var(--bg-white); padding: 2px 6px; border-radius: 99px;"
                        id="stickyCount">
                        <%= typeof cartCount !=='undefined' ? cartCount : 0 %> x
                    </span>
                </div>
            </div>
        </div>

        <button onclick="window.location.href='/cart'" class="checkout-pulse-btn" style="
            background: var(--bg-white); 
            color: #FF5252; 
            border: none; 
            padding: 8px 16px; 
            border-radius: 99px; 
            font-size: 13px;
            font-weight: 800; 
            cursor: pointer; 
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            gap: 6px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        ">
            <span data-i18n="index.continue">Lanjut</span> <span style="font-size: 14px;">‚ûî</span>
        </button>
    </div>

    <style>
        @keyframes floatUp {
            from {
                transform: translateY(100px) scale(0.9);
                opacity: 0;
            }

            to {
                transform: translateY(0) scale(1);
                opacity: 1;
            }
        }

        .checkout-pulse-btn:hover {
            transform: scale(1.05) translateY(-2px);
            box-shadow: 0 10px 25px -5px rgba(255, 255, 255, 0.3);
            background: var(--bg-light);
        }

        .checkout-pulse-btn:active {
            transform: scale(0.95);
        }
    </style>

    <script>
        // Live Search Simulation
        const searchInput = document.querySelector('input[name="search"]');
        if (searchInput) {
            let timeout = null;
            searchInput.addEventListener('keyup', function (e) {
                clearTimeout(timeout);
                timeout = setTimeout(function () {
                    // Only submit if value changed or on enter (default form behavior handles enter)
                    searchInput.form.submit();
                }, 800); // 800ms debounce
            });

            // Focus back on input after reload
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.has('search')) {
                searchInput.focus();
                // Move cursor to end
                const val = searchInput.value;
                searchInput.value = '';
                searchInput.value = val;
            }
        }

        // AJAX Add to Cart
        document.querySelectorAll('form[action="/cart/add"]').forEach(form => {
            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                const btn = form.querySelector('button');
                const originalText = btn.innerHTML;
                btn.innerHTML = '‚è≥...';
                btn.disabled = true;

                try {
                    const formData = new URLSearchParams(new FormData(form));
                    const response = await fetch('/cart/add', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                            'Accept': 'application/json',
                            'X-Requested-With': 'XMLHttpRequest'
                        },
                        body: formData
                    });
                    const data = await response.json();

                    if (data.success) {
                        // Show Toast
                        window.showToast(data.message || t('toast.add_success'), 'success');

                        // Update Sticky Bar
                        updateStickyBar(data.cartCount, data.cartTotal);
                    } else {
                        window.showToast(data.message || t('toast.add_failed'), 'error');
                    }
                } catch (err) {
                    console.error(err);
                    window.showToast(t('toast.connection_error'), 'error');
                } finally {
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                }
            });
        });

        function updateStickyBar(count, total) {
            // Update Sticky Bar
            let bar = document.getElementById('stickyCheckoutBar');
            if (bar) {
                if (count > 0) {
                    bar.style.display = 'flex';
                    document.getElementById('stickyCount').textContent = count + ' ' + t('index.item_suffix');
                    document.getElementById('stickyTotal').textContent = 'Rp ' + parseInt(total).toLocaleString('id-ID');
                } else {
                    bar.style.display = 'none';
                }
            }

            // Update Header Badge
            const badge = document.getElementById('cartBadge');
            if (badge) {
                badge.innerText = count;
                if (count > 0) badge.style.display = 'flex';
                else badge.style.display = 'none';
            }
        }
    </script>

    <%- include('partials/footer') %>